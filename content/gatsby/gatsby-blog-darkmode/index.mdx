---
title: 'Gatsby ë¸”ë¡œê·¸ ë‹¤í¬ ëª¨ë“œ ì ìš©í•˜ê¸°'
category: gatsby
date: 2023-06-16
tags:
  - ë¸”ë¡œê·¸
  - darkmode
---

# ë“¤ì–´ê°€ë©°

ì´ì œëŠ” ë‹¹ì—°í•˜ê²Œ ì‚¬ìš©ë˜ëŠ” ë‹¤í¬ ëª¨ë“œë¥¼ ë¸”ë¡œê·¸ì— ì ìš©í•˜ë ¤ê³  í•œë‹¤. ì†”ì§íˆ ì—„ì²­ ê°„ë‹¨í•  ê²ƒì´ë¼ê³  ìƒê°í–ˆëŠ”ë° ë¸”ë¡œê·¸ë¥¼ ì œì‘í•˜ë©´ì„œ ì œì¼ ë§ì€ ì‹œê°„ì„ íˆ¬ìí–ˆë‹¤. ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œ ë‹¤í¬ ëª¨ë“œë¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ê³¼ í•¨ê»˜ ë‚´ê°€ ê²ªì—ˆë˜ ë¬¸ì œì ë“¤ì„ ê³µìœ í•˜ë ¤ê³  í•œë‹¤.

ë¨¼ì € ê¸°ëŠ¥ êµ¬í˜„ì„ í•˜ê³  íšŒê³ ë¥¼ í•˜ëŠ” ê²ƒì´ë‹¤ ë³´ë‹ˆ, ì¤‘ê°„ ê³¼ì • ì½”ë“œë“¤ì€ ì˜ˆì‹œì •ë„ë¡œë§Œ ë³´ê³  ë„˜ì–´ê°€ì.ğŸ˜…

# ì²˜ìŒìœ¼ë¡œ êµ¬í˜„í•œ ë‹¤í¬ ëª¨ë“œ

ë¨¼ì € í•„ìê°€ ì œì‘í•œ Gatsby ë¸”ë¡œê·¸ëŠ” `Styled Components`ë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤. ê·¸ë˜ì„œ ThemeProviderë¥¼ ì‚¬ìš©í•´ì„œ ë‹¤í¬ëª¨ë“œë¥¼ êµ¬í˜„í•˜ë ¤ê³  í–ˆë‹¤.

ë‹¤ìŒê³¼ ê°™ì´ ìƒ‰ìƒ ë³€ìˆ˜ë¥¼ ì •ì˜í•˜ê³ , ì´ ìƒ‰ìƒ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ theme ê°ì²´ë¥¼ ì •ì˜í–ˆë‹¤.

```js
const PRIMARY0 = 'hsl(210, 1%, 98%)';
const PRIMARY1 = 'hsl(210, 2%, 95%)';
const PRIMARY2 = 'hsl(210, 3%, 93%)';
const PRIMARY3 = 'hsl(210, 3%, 89%)';
const PRIMARY4 = 'hsl(210, 6%, 83%)';
const PRIMARY5 = 'hsl(210, 8%, 71%)';
const PRIMARY6 = 'hsl(210, 11%, 56%)';
const PRIMARY7 = 'hsl(210, 16%, 31%)';
const PRIMARY8 = 'hsl(210, 19%, 23%)';
const PRIMARY9 = 'hsl(210, 20%, 15%)';

export const lightTheme = {
  bgColor: PRIMARY0,
  textColor: PRIMARY9,
  ...
};

export const darkTheme = {
  bgColor: PRIMARY9,
  textColor: PRIMARY0,
  ...
};
```

ê·¸ëŸ°ë° ìœ„ ë°©ë²•ìœ¼ë¡œ êµ¬í˜„í•˜ê³  ë¬¸ì œê°€ ìƒê²¼ë‹¤! í™”ë©´ì´ ê¹œë¹¡ì´ëŠ” `FOUC(Flash of Unstyled Content)`ê°€ ë°œìƒí•œ ê²ƒì´ë‹¤. ì´ ë¬¸ì œëŠ” ë ˆë”ë§ ë˜ê¸° ì „ì— ìŠ¤íƒ€ì¼ì´ ì ìš©ë˜ì§€ ì•Šê³  ë Œë”ë§ ì´í›„ì— `ThemeProvider`ì— ì˜í•´ ìŠ¤íƒ€ì¼ì´ ì ìš©ë˜ê¸° ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ë¬¸ì œë‹¤.

`FOUC`ê°€ ë°œìƒí•˜ë©´ ì°°ë‚˜ì˜ ìˆœê°„ì´ê¸´ í•˜ì§€ë§Œ ì‚¬ìš©ì ê²½í—˜ì— ì¢‹ì§€ ì•Šê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ ë°©ë²•ì„ ì°¾ì•„ë³´ê¸°ë¡œ í–ˆë‹¤.

# CSS Variables ì‚¬ìš©í•˜ê¸°

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ í•œ ê°€ì§€ ë°©ë²•ì€ `CSS Variables`ë¥¼ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆë‹¤. htmlì˜ `data-theme` ì†ì„±ì„ ë³€ê²½í•˜ë©´ì„œ ë‹¤í¬ ëª¨ë“œë¥¼ ì ìš©í•˜ê¸° ìœ„í•´ì„œë‹¤. ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ JavsScriptê°€ ë¡œë“œë˜ê¸° ì „(ë Œë”ë§ ë˜ê¸°ì „)ì— CSSë¥¼ ì ìš©í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— `FOUC` ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤ê³  ìƒê°í–ˆë‹¤. ë¯¸ì•½í•œ ë‚˜ì˜ ì§€ì‹ìœ¼ë¡œëŠ” ì´ ë°©ë²•ë°–ì— ë– ì˜¤ë¥´ì§€ ì•ŠëŠ”ë‹¤.ğŸ¥²

ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜ì˜ ë””ìì¸ ì‹œìŠ¤í…œì„ ì¼ê´€ë˜ê²Œ ìœ ì§€í•˜ê¸° ìœ„í•´ Styled Componentsì˜ `createGlobalStyle`ë¥¼ ì‚¬ìš©í–ˆë‹¤.

> **ğŸ’¡ Tip!**
>
> `createGlobalStyle`ë¥¼ ì‚¬ìš©í•  ë•Œ prettierê°€ ì ìš©ë˜ì§€ ì•ŠëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆëŠ”ë° ì½”ë“œë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ë©´ í•´ê²°í•  ìˆ˜ ìˆë‹¤.
>
> ```js
> import { createGlobalStyle, css } from 'styled-components';
>
> export default createGlobalStyle`${css`
>   // style code
> `}`;
> ```

ì•„ë˜ ì½”ë“œì²˜ëŸ¼ CSS ë³€ìˆ˜ë¥¼ ì •ì˜í•˜ê³ , `data-theme='dark'` ì†ì„±ì„ ê°€ì§„ ìš”ì†Œì— ë‹¤í¬ ëª¨ë“œì—ì„œ ì‚¬ìš©í•  CSS ê°’ì„ ì„¤ì •í•œë‹¤. **ê¼­ lightThemeì˜ CSS ë³€ìˆ˜ì™€ darkThemeì˜ CSS ë³€ìˆ˜ ì´ë¦„ì´ 1:1 ë§¤í•‘ë˜ë„ë¡ ì‘ì„±í•´ì£¼ì–´ì•¼ í•œë‹¤.** ì´ ë¶€ë¶„ì´ ê°€ì¥ ë…¸ê°€ë‹¤ê°€ ì‹¬í•œ ë¶€ë¶„ì´ì—ˆë‹¤.

```js
import { createGlobalStyle, css } from 'styled-components';

export default createGlobalStyle`${css`
  :root {
    --bgColor: ${({ theme }) => theme.colors.primary0};
    --textColor: ${({ theme }) => theme.colors.primary9};
    ...
  }

  [data-theme='dark'] {
    --bgColor: ${({ theme }) => theme.colors.primary9};
    --textColor: ${({ theme }) => theme.colors.primary0};
    ...
  }
`}`;
```

í•„ìëŠ” `gatsby-browser.js`ì™€ `gatsby-ssr.js`ì— `ThemeProvider`ë¡œ ìœ„ `GlobalStyle`ì„ ê°ì‹¸ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ ì‘ì„±í–ˆë‹¤.

```js
import { ThemeProvider } from 'styled-components';

import GlobalStyle from './src/style/globalStyle';
import theme from './src/style/variables';

export const wrapPageElement = ({ element }) => (
  <ThemeProvider theme={theme}>
    <GlobalStyle />
    {element}
  </ThemeProvider>
);
```

ì´ì œ ë‹¤ìŒ ì½”ë“œì™€ ê°™ì´ CSS ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ìƒ‰ìƒì„ í•œ ë²ˆë§Œ ì„ ì–¸í•˜ë©´ ëœë‹¤. ì´ê²ƒ ë•Œë¬¸ì— 1:1 ë§¤í•‘í•´ì„œ ì„ ì–¸í•˜ë¼ê³  í•œê±°ë‹¤! ğŸ˜

```js
const Container = styled.div`
  background-color: var(--bgColor);
  color: var(--textColor);
  ...
`;
```

<br />
<br />

---

<br />

# ë‹¤í¬ ëª¨ë“œ ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸°

ì´ì œ ìƒ‰ìƒ ì„¤ì •ì€ ëë‚¬ìœ¼ë‹ˆ ë³¸ê²©ì ìœ¼ë¡œ ë‹¤í¬ ëª¨ë“œ ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ì. ìš°ì„ , ë‹¤í¬ ëª¨ë“œë¥¼ ì ìš©í•˜ëŠ” ë°©ë²•ì„ ë‹¤ì‹œ í•œ ë²ˆ ì •ë¦¬í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

1.  ìƒ‰ìƒì„ createGlobalStyleë¥¼ ì´ìš©í•´ `CSS Variables` í˜•íƒœë¡œ êµ¬í˜„í•œë‹¤**(ì™„ë£Œ)**.
2.  ì»¬ëŸ¬ ëª¨ë“œë¥¼ ë³€ê²½í•˜ëŠ” ë°©ë²•ì€ `data-theme` ì†ì„±ì„ ë³€ê²½í•˜ëŠ” ê²ƒìœ¼ë¡œ êµ¬í˜„í•œë‹¤**(ì§€ê¸ˆë¶€í„°)**.

## getCurrentTheme í•¨ìˆ˜ ìƒì„±

ë‹¤í¬ ëª¨ë“œ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë©´ì„œ **ì‚¬ìš©ì í™˜ê²½ ì„¤ì • í…Œë§ˆ ê°’**ì— ë”°ë¼ì„œë„ ë‹¤í¬ëª¨ë“œê°€ ì ìš©ë  ìˆ˜ ìˆìœ¼ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤. ì´ë¥¼ ê³ ë ¤í•´ì„œ ë‹¤ìŒê³¼ ê°™ì€ ìš°ì„ ìˆœìœ„ë¥¼ ì •í–ˆë‹¤.

1. ì´ì „ì— ë°©ë¬¸í–ˆë˜ ì ì´ ìˆì–´ì„œ `localStorage`ì— ì €ì¥ëœ ê°’ì´ ìˆë‹¤ë©´ ê·¸ ê°’ì„ ì‚¬ìš©í•œë‹¤.
2. ì‚¬ìš©ìì˜ ì‹œìŠ¤í…œ í…Œë§ˆê°€ ë‹¤í¬ ëª¨ë“œë¼ë©´ ë‹¤í¬ ëª¨ë“œë¥¼ ì‚¬ìš©í•œë‹¤.
3. ê·¸ ì™¸ì˜ ê²½ìš°ì—ëŠ” ë¼ì´íŠ¸ ëª¨ë“œë¥¼ ì‚¬ìš©í•œë‹¤.

ìœ„ì™€ ê°™ì€ ìš°ì„ ìˆœìœ„ë¥¼ ì •í•œ ì´ìœ ëŠ” ì‚¬ìš©ìì˜ ê°œì¸ ì„¤ì •ê³¼ ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¤ì • ì‚¬ì´ì— ì ì ˆí•œ ê· í˜•ì„ ì°¾ê¸° ìœ„í•´ì„œë‹¤. ë§Œì•½ ì‚¬ìš©ìê°€ ì´ì „ì— ë¸”ë¡œê·¸ë¥¼ ë°©ë¬¸í–ˆê³  í…Œë§ˆë¥¼ ë³€ê²½í–ˆë‹¤ë©´, ê·¸ ë³€ê²½ ì‚¬í•­ì„ localStorageì— ì €ì¥í•˜ê³  ì´ ê°’ì„ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì‚¬ìš©ìì˜ ê°œì¸í™”ëœ ì„¤ì •ì´ ìœ ì§€ëœë‹¤. ê·¸ëŸ¬ë‚˜ ì‚¬ìš©ìê°€ ë¸”ë¡œê·¸ë¥¼ ì²˜ìŒ ë°©ë¬¸í•œ ê²½ìš°, ì‹œìŠ¤í…œ ì„¤ì •ì„ ë”°ë¥´ë„ë¡ í•˜ëŠ” ê²ƒì´ë‹¤.

ì—¬ê¸°ì„œ ì‚¬ìš©ìì˜ ì‚¬ìš©ì í™˜ê²½ ì„¤ì • í…Œë§ˆ ê°’ì„ íŒŒì•…í•  ìˆ˜ ìˆì„ê¹Œ? ì´ëŠ” `prefers-color-scheme` ë¯¸ë””ì–´ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ë©´ ì•Œ ìˆ˜ ìˆì—ˆë‹¤! ì´ ë¯¸ë””ì›Œ ì¿¼ë¦¬ëŠ” ì‚¬ìš©ìì˜ ì‹œìŠ¤í…œ í…Œë§ˆê°€ ë‹¤í¬ ëª¨ë“œì¸ì§€ ë¼ì´íŠ¸ ëª¨ë“œì¸ì§€ `boolean` ê°’ì„ ë°˜í™˜í•œë‹¤.

ìœ„ ìš°ì„ ìˆœìœ„ë¥¼ ê³ ë ¤í•´ì„œ ë§Œë“  í•¨ìˆ˜ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```ts
export function getCurrentTheme(): ThemeMode {
  const localTheme = getValue('themeMode');
  if (localTheme) return localTheme;

  if (typeof window !== 'undefined') {
    const colorSchemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
    const systemTheme = colorSchemeQuery.matches ? 'dark' : 'light';
    return systemTheme;
  }
}
```

## Redux Slice ìƒì„±

ë‹¤í¬ ëª¨ë“œ í…Œë§ˆë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ ì „ì—­ ìƒíƒœ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ **Redux**ë¥¼ ì‚¬ìš©í–ˆë‹¤. ê·¸ë¦¬ê³  initialStateì˜ `themeMode`ë¥¼ `getCurrentTheme` í•¨ìˆ˜ë¡œ ì„¤ì •í–ˆë‹¤. ì´ì œ ë¸Œë¼ìš°ì €ê°€ ìƒˆë¡œê³ ì¹¨ë˜ë”ë¼ë„ ì´ì „ì— ì„¤ì •í•œ í…Œë§ˆë¥¼ ìœ ì§€í•  ìˆ˜ ìˆë‹¤.

```ts
import { createSlice } from '@reduxjs/toolkit';
import { getCurrentTheme } from '@utils/getCurrentTheme';

const initialState: DarkModeState = {
  themeMode: getCurrentTheme(),
};

const darkModeSlice = createSlice({
  name: 'darkMode',
  initialState,
  reducers: {
    setTheme(state, action) {
      state.themeMode = action.payload.themeMode;
    },
  },
});

export const { setTheme } = darkModeSlice.actions;
export default darkModeSlice.reducer;
```

í˜¹ì‹œë‚˜ í•„ìê°€ ê°€ì§€ê³  ìˆë˜ ì˜ë¬¸ì„ ê°€ì§€ì‹  ë¶„ë“¤ì„ ìœ„í•´ ì¶”ê°€ì ìœ¼ë¡œ ì„¤ëª…í•˜ìë©´, `getCurrentTheme` í•¨ìˆ˜ë¥¼ initialStateë¡œ ì„ ì–¸í•˜ë”ë¼ë„ FOUC ë¬¸ì œëŠ” í•´ê²°ë˜ì§€ ì•ŠëŠ”ë‹¤. ìœ„ ì½”ë“œëŠ” ë Œë”ë§ ì´í›„ì— ì‹¤í–‰ë˜ëŠ” ê²ƒì´ê³  FOUC ë¬¸ì œë¥¼ í•´ê²°í•˜ë ¤ë©´ ë ˆë”ë§ ì´ì „ì— ì¶”ê°€ì ì¸ ì‘ì—…ì´ í•„ìš”í•˜ë‹¤. ì´ ë¶€ë¶„ì€ ì•„ë˜ì„œ ì„¤ëª…í•˜ê² ë‹¤.

## useSysThemeEffect ì»¤ìŠ¤í…€ í›… ë§Œë“¤ê¸°

ì´ ì»¤ìŠ¤í…€ í›…ì€ **ì‹œìŠ¤í…œ í…Œë§ˆê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ, í…Œë§ˆë¥¼ ë³€ê²½í•˜ëŠ” ì—­í• **ì„ í•œë‹¤.

```ts
import { setTheme } from '@store/modules/darkMode';
import { getValue } from '@utils/storage';

export const useSysThemeEffect = () => {
  const dispatch = useAppDispatch();

  const checkSystemTheme = useCallback((e: MediaQueryListEvent) => {
    const newPrefersColorScheme = e.matches ? 'dark' : 'light';
    const newTheme = getValue('themeMode') || newPrefersColorScheme;
    dispatch(setTheme({ themeMode: newTheme, saveToLocalStorage: false }));
  }, []);

  useEffect(() => {
    const colorSchemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
    colorSchemeQuery.addEventListener('change', checkSystemTheme);

    return () =>
      colorSchemeQuery.removeEventListener('change', checkSystemTheme);
  }, [checkSystemTheme, dispatch]);
};
```

ì´ì œ ì½”ë“œë¥¼ ìì„¸íˆ ì‚´í´ë³´ì. ì½”ë“œì—ì„œ `setTheme`ì„ `dispatch`í•˜ëŠ” ë¶€ë¶„ì„ ë³´ë©´ `saveToLocalStorage`ë¥¼ ì „ë‹¬í•˜ê³  ìˆë‹¤. ì´ëŠ” `localStorage` ì €ì¥ ì—¬ë¶€ë¥¼ ê²°ì •í•˜ëŠ” ê°’ì´ë‹¤.

ì´ë ‡ê²Œ êµ¬ë¶„í•œ ì´ìœ ëŠ” ìœ„ì—ì„œ ì–¸ê¸‰í•œ ìš°ì„  ìˆœìœ„ë¥¼ ë”°ë¥´ê¸° ìœ„í•´ì„œë‹¤. ì‹œìŠ¤í…œ í…Œë§ˆë¥¼ `localStorage`ì— ì €ì¥í•˜ê²Œ ë˜ë©´ ì´ëŠ” ì‚¬ìš©ìì˜ ê°œì¸ ì„¤ì •ì´ ë˜ê¸° ë•Œë¬¸ì— ì‹œìŠ¤í…œ í…Œë§ˆê°€ ë³€ê²½ë˜ì–´ë„ `localStorage`ì— ì €ì¥ëœ í…Œë§ˆê°€ ìš°ì„ ì ìœ¼ë¡œ ì ìš©ë˜ë²„ë¦¬ê¸° ë•Œë¬¸ì´ë‹¤.

ì •ë¦¬í•˜ìë©´ ì´í›„ì— ë§Œë“¤ í† ê¸€ ë²„íŠ¼ì„ í´ë¦­í•´ì„œ í…Œë§ˆë¥¼ ë³€ê²½í–ˆì„ ë•Œë§Œ `localStorage`ì— ì €ì¥í•˜ê³ , ì‹œìŠ¤í…œ í…Œë§ˆê°€ ë³€ê²½ë˜ì—ˆì„ ë•ŒëŠ” `localStorage`ì— ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.

### Redux Middleware

`setTheme`ì„ `dispatch`í•  ë•Œ, `saveToLocalStorage`ë¥¼ ì „ë‹¬í•˜ì§€ë§Œ redux ì½”ë“œì—ì„œëŠ” ì´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ì´ ì—†ë‹¤. ì‚¬ì‹¤ ì²˜ìŒì—ëŠ” ì´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ì„ ë¦¬ë“€ì„œì— êµ¬í˜„í–ˆì—ˆë‹¤.

```ts
const darkModeSlice = createSlice({
  name: 'darkMode',
  initialState,
  reducers: {
    setTheme(state, action) {
      const { themeMode, saveToLocalStorage } = action.payload;
      if (saveToLocalStorage) {
        setValue('themeMode', themeMode);
      }
      document.documentElement.dataset.theme = themeMode;
      state.themeMode = themeMode;
    },
  },
});
```

í•˜ì§€ë§Œ, ì´ëŠ” [Reduxì˜ ì„¤ê³„ ì›ì¹™](https://redux.js.org/understanding/thinking-in-redux/three-principles)ì— ì–´ê¸‹ë‚˜ëŠ” ë°©ë²•ì´ê¸° ë•Œë¬¸ì— ì´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ì„ `middleware`ë¡œ ë¶„ë¦¬í–ˆë‹¤.

`createAsyncThunk`ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ middlewareì— `redux-logger`ë¥¼ ì¶”ê°€í•´ì„œ ì‚¬ìš©í•´ë³¸ì ì€ ìˆì§€ë§Œ ì´ëŸ° **side effect**ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•´ë³¸ ì ì€ ì´ë²ˆì´ ì²˜ìŒì´ë‹¤. ~~ë”°ë¼ì„œ ë§¤ìš° êµ¬ë¦° ì½”ë“œì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ ë§Œ í•˜ê¸° ë°”ë€ë‹¤..ğŸ˜…~~

middleware ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```ts
// themeMiddleware.ts

import { Middleware } from '@reduxjs/toolkit';
import { setValue } from '@utils/storage';

export const themeMiddleware: Middleware = () => next => action => {
  if (action.type === 'darkMode/setTheme') {
    const { themeMode, saveToLocalStorage } = action.payload;
    if (saveToLocalStorage) {
      setValue('themeMode', themeMode);
    }
    if (typeof document !== 'undefined') {
      document.documentElement.dataset.theme = themeMode;
    }
  }
  next(action);
};
```

```ts
// store.ts

import { configureStore, combineReducers } from '@reduxjs/toolkit';

import darkModeSlice from './modules/darkMode';
import { themeMiddleware } from './modules/themeMiddleware';

const rootReducer = combineReducers({ darkMode: darkModeSlice });

const store = configureStore({
  reducer: rootReducer,
  middleware: getDefaultMiddleware =>
    getDefaultMiddleware().prepend(themeMiddleware),
});

export default store;

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

## ThemeToggle ì»´í¬ë„ŒíŠ¸ ë§Œë“¤ê¸°

ì´ì œ ë‹¤í¬ ëª¨ë“œë¥¼ í† ê¸€í•  ìˆ˜ ìˆëŠ” ë²„íŠ¼ì„ ë§Œë“¤ ì°¨ë¡€ì´ë‹¤. ë¨¼ì € ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```tsx
import React from 'react';
import { AnimatePresence, motion } from 'framer-motion';

import { useAppDispatch, useAppSelector } from '@hooks/reduxHooks';
import { setTheme } from '@store/modules/darkMode';

// CSS
import * as S from './style';
import { FaSun, FaMoon } from 'react-icons/fa';

const ThemeIcon = {
  dark: <FaSun />,
  light: <FaMoon />,
};

const ThemeToggleButton = () => {
  const { themeMode } = useAppSelector(state => state.darkMode);
  const dispatch = useAppDispatch();

  const themeToggleHandler = () => {
    const nextTheme = themeMode === 'dark' ? 'light' : 'dark';
    dispatch(setTheme({ themeMode: nextTheme, saveToLocalStorage: true }));
  };

  return (
    <S.ToggleWrapper onClick={themeToggleHandler}>
      <AnimatePresence exitBeforeEnter initial={false}>
        <motion.div
          key={themeMode}
          initial={{ rotate: -180, opacity: 1 }}
          animate={{ rotate: 0, opacity: 1 }}
          exit={{ rotate: 180, opacity: 0 }}
          transition={{ duration: 0.3 }}
        >
          {ThemeIcon[themeMode]}
        </motion.div>
      </AnimatePresence>
    </S.ToggleWrapper>
  );
};

export default ThemeToggleButton;
```

ì—¬ê¸°ì„œëŠ” `setTheme`ì„ `dispatch`í•  ë•Œ, `saveToLocalStorage`ë¥¼ `true`ë¡œ ì „ë‹¬í–ˆë‹¤. ì´ëŠ” ì‚¬ìš©ìê°€ ì˜ë„ì ìœ¼ë¡œ í…Œë§ˆë¥¼ ë³€ê²½í–ˆë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤. `localStorage`ê°€ ìš°ì„ ìˆœìœ„ì—ì„œ ë” ë†’ê²Œ ì ìš©ë˜ê¸° ë•Œë¬¸ì— ë²„íŠ¼ì„ í´ë¦­í•œ ë‹¤ìŒ ì‹œìŠ¤í…œ í…Œë§ˆê°€ ë³€ê²½ë˜ì–´ë„ `localStorage`ì— ì €ì¥ëœ í…Œë§ˆê°€ ì ìš©ëœë‹¤.

## FOUC ë¬¸ì œ í•´ê²°í•˜ê¸°

![fouc-error](./image/fouc-error.gif)

ì—¬ê¸°ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤! ë‹¤í¬ ëª¨ë“œë¥¼ ì ìš©í•˜ê³  ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨ í•˜ë©´ ìœ„ì™€ ê°™ì´ í™”ë©´ì´ ê¹œë¹¡ì´ëŠ” í˜„ìƒì´ ë°œìƒí•œë‹¤.

ì´ë¥¼ `FOUC (Flash of unstyled content)`ë¼ê³  í•œë‹¤. í™”ë©´ì´ ì™„ì „íˆ ë Œë”ë§ ë˜ê¸° ì „ì— í…Œë§ˆê°€ ì ìš©ë˜ì§€ ì•Šì•„ì„œ ìƒê¸°ëŠ” ë¬¸ì œë‹¤. ë”°ë¼ì„œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œëŠ” ì²˜ë¦¬í•  ìˆ˜ ì—†ê³ , ì„œë²„ ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬í•´ì•¼ í•œë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `gatsby-ssr.js`ì— ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œë¥¼ ì¶”ê°€í–ˆë‹¤.

```js
// gatsby-ssr.js

const darkModeScript = `
(function() {
  const value = window.localStorage.getItem('themeMode');
  const localTheme = JSON.parse(value);
  if (localTheme) {
    document.documentElement.dataset.theme = localTheme;
    return;
  }

  const systemTheme = window.matchMedia('(prefers-color-scheme: dark)');
  if(systemTheme.matches) {
    document.documentElement.dataset.theme = 'dark';
  } else {
    document.documentElement.dataset.theme = 'light';
  }
})();
`;

export const onRenderBody = ({ setPreBodyComponents }) => {
  setPreBodyComponents([
    createElement('script', {
      key: 'darkModeScript',
      dangerouslySetInnerHTML: {
        __html: darkModeScript,
      },
    }),
  ]);
};
```

ì´ ì½”ë“œëŠ” ë¸Œë¼ìš°ì €ì— ë Œë”ë§ë˜ê¸° ì „ì— ì‹¤í–‰ë˜ëŠ” ì½”ë“œì´ë‹¤. `localStorage`ì— ì €ì¥ëœ í…Œë§ˆê°€ ìˆë‹¤ë©´ ê·¸ ê°’ì„ ê°€ì ¸ì˜¤ê³ , ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ ì‹œìŠ¤í…œ í…Œë§ˆë¥¼ ê°€ì ¸ì™€ `data-theme`ì„ ì—…ë°ì´íŠ¸ ì‹œì¼œì¤€ë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë¸Œë¼ìš°ì €ê°€ ë Œë”ë§ë˜ê¸° ì „ì— í…Œë§ˆê°€ ì ìš©ë˜ê¸° ë•Œë¬¸ì— `FOUC`ê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

![fouc-success](./image/fouc-success.gif)

ì™„ë²½í•˜ë‹¤ ğŸ˜

# ë§ˆì¹˜ë©°

ë¸”ë¡œê·¸ì— ë‹¤í¬ ëª¨ë“œë¥¼ ì ìš©í•˜ë©´ì„œ ì´ì „ì—ëŠ” ê³ ë ¤í•´ë³´ì§€ ì•Šì•˜ë˜ ì‚¬ìš©ì ê²½í—˜ë„ ê°œì„ í•´ë³´ì•˜ë‹¤. ìƒ‰ìƒì„ ì„ ì •í•˜ê³  ì ìš©í•˜ëŠ” ê²ƒë„ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ì‘ì—…ì´ì—ˆë‹¤. ì»´í¬ë„ŒíŠ¸ê°€ ë§ì§€ ì•Šì•„ì„œ ë‹¤í–‰ì´ì—ˆì§€ë§Œ, ì»´í¬ë„ŒíŠ¸ê°€ ë§ë‹¤ë©´ ì´ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²ƒë„ ì‰½ì§€ ì•Šì„ ê²ƒ ê°™ë‹¤.

ì•„ì§ì€ ì½”ë“œê°€ ê¹”ë”í•˜ì§€ ì•Šë‹¤ê³  ìƒê°ë˜ì§€ë§Œ, ë¸”ë¡œê·¸ë¥¼ ë§Œë“¤ë©´ì„œ ê¼­ ì ìš©í•˜ê³  ì‹¶ë˜ ê¸°ëŠ¥ì„ ì ìš©í•´ì„œ ë¿Œë“¯í•˜ë‹¤.ğŸ˜

í‰ì†Œì— ë‹¹ì—°í•˜ë‹¤ê³  ëŠë¼ë˜ ê¸°ëŠ¥ë“¤ì´ ì–¼ë§ˆë‚˜ ë§ì€ ê³ ë¯¼ê³¼ ì‹œê°„ì´ í•„ìš”í•œì§€ ì•Œê²Œ ë˜ì—ˆë‹¤. ì‚¬ìš©ì ê²½í—˜ì´ ë§¤ìš° ì¤‘ìš”í•˜ë‹¤ê³  ëŠê¼ˆê³  ì´ë¥¼ ê³ ë ¤í•´ì„œ ê°œë°œí•˜ë©´ì„œ ì„œë²„ ì‚¬ì´ë“œì— ëŒ€í•œ ê³µë¶€ë„ í•˜ê²Œ ë˜ê³  ì •ë§ ì¢‹ì€ ê²½í—˜ì´ì—ˆë‹¤. ì§€ê¸ˆì€ ì„œë²„ ì‚¬ì´ë“œì— ëŒ€í•œ ì´í•´ë„ê°€ ì¶©ë¶„í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ê¼­ ì´ ë¶€ë¶„ì„ ê³µë¶€í•´ì•¼ê² ë‹¤.

ìœ„ ê³¼ì •ì— ëŒ€í•œ ìì„¸í•œ ì½”ë“œëŠ” [ê¹ƒí—ˆë¸Œ](https://github.com/CH4MD0M/gatsby-starter-dom)ë¥¼ ì°¸ê³ í•˜ë©´ ëœë‹¤.

<br />

---

# ì°¸ê³ 

- [CSSë³€ìˆ˜ë¥¼ í™œìš©í•˜ì—¬ ë‹¤í¬ ëª¨ë“œ êµ¬í˜„í•˜ê¸°](https://jthcast.dev/posts/how-to-make-dark-mode-with-css-variables/)
- [ë²¨ë¡œê·¸ì— ë‹¤í¬ ëª¨ë“œ ì ìš©í•˜ê¸°](https://velog.io/@velopert/velog-dark-mode#styled-components%EC%97%90%EC%84%9C-css-variable-%EC%93%B0%EA%B8%B0)
- [Gatsby Blog ë‹¤í¬ ëª¨ë“œ ì ìš©ê¸°](https://www.sungikchoi.com/blog/gatsby-dark-mode/)
- [kaicataldo/gatsby-ssr.js](https://gist.github.com/kaicataldo/f28b6adf941d1575afa78e647624a327#file-gatsby-ssr-js-L8)
- [Gatsby, Lumen and Dark Mode](https://jmartins.dev/posts/gatsby-lumen-and-dark-mode)
